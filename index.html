<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Golf Practice ‚Äî v1.5 (Minimal)</title>
  <script src="https://unpkg.com/dexie@latest/dist/dexie.min.js"></script>
  <style>
    :root{ --bg:#0e1116; --card:#141922; --muted:#92a2b6; --text:#e8eef6; --accent:#60a5fa; --good:#22c55e; --bad:#ef4444; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Arial}
    .container{max-width:980px;margin:0 auto;padding:16px}
    .row{display:flex;gap:10px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .grow{flex:1}
    .btn{background:#1f2937;color:#fff;border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent}
    .btn.ghost{background:transparent}
    .btn.danger{background:var(--bad)}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#101522;color:var(--text)}
    label{display:block;font-weight:600;margin:6px 0 6px}
    .card{background:var(--card);border-radius:16px;padding:14px;margin:10px 0;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .list{display:grid;gap:10px}
    .item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:#0f1420;border:1px solid rgba(255,255,255,.08)}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .head{display:flex;justify-content:space-between;align-items:center}
    .accordion .section{margin:8px 0}
    .accordion .head{cursor:pointer;background:#101522;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px}
    .accordion .body{padding:8px 0 0}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:50}
    .dialog{background:#141922;border-radius:16px;padding:16px;max-width:520px;width:92%}
  </style>
</head>
<body>
  <div class="container">
    <div class="row wrap" style="margin-bottom:10px">
      <h1 class="grow">üèåÔ∏è‚Äç‚ôÇÔ∏è Golf Practice</h1>
      <div class="row" role="toolbar">
        <button class="btn ghost" data-nav="home">Home</button>
        <button class="btn ghost" data-nav="library">Library</button>
        <button class="btn ghost" data-nav="settings">Settings</button>
      </div>
    </div>

    <!-- HOME (landing) -->
    <div id="view-home" class="card">
      <h2>Quick Actions</h2>
      <div class="row wrap" style="margin-top:8px">
        <button id="btn-start" class="btn primary">Start Practice</button>
        <button id="btn-continue" class="btn">Continue Last</button>
      </div>
      <div class="card">
        <h3>Recent Sessions</h3>
        <div id="recent-sessions" class="list"></div>
      </div>
    </div>

    <!-- LIBRARY -->
    <div id="view-library" class="hidden">
      <div class="card">
        <div class="row wrap">
          <h2 class="grow">Library</h2>
          <input id="lib-search" placeholder="Search‚Ä¶" />
          <select id="lib-filter-section">
            <option value="">All Sections</option>
            <option>Putting</option>
            <option>Chipping</option>
            <option>Range</option>
            <option>Course</option>
          </select>
          <select id="lib-filter-type">
            <option value="">All Types</option>
            <option>Drill</option>
            <option>Game</option>
            <option>Course</option>
            <option>Note</option>
          </select>
          <button id="btn-add-item" class="btn">Add Item</button>
        </div>
        <div id="lib-list" class="list" style="margin-top:10px"></div>
      </div>

      <div id="lib-editor" class="card">
        <h3 id="editor-title">Add / Edit Item</h3>
        <div class="row wrap">
          <div class="grow"><label>Name</label><input id="f-name"/></div>
          <div class="grow"><label>Section</label>
            <select id="f-section"><option value="">‚Äî</option><option>Putting</option><option>Chipping</option><option>Range</option><option>Course</option></select>
          </div>
          <div class="grow"><label>Type</label>
            <select id="f-type"><option value="">‚Äî</option><option>Drill</option><option>Game</option><option>Course</option><option>Note</option></select>
          </div>
          <div class="grow"><label>Active</label>
            <select id="f-active"><option value="true">Yes</option><option value="false">No</option></select>
          </div>
        </div>
        <div class="row wrap">
          <div class="grow"><label>Primary Metric</label><select id="f-primary"></select></div>
          <div class="grow"><label>Tags (comma)</label><input id="f-tags"/></div>
        </div>
        <div class="row wrap">
          <span class="muted">Quick add fields:</span>
          <button class="btn ghost" id="btn-add-distance">+ Distance</button>
          <button class="btn ghost" id="btn-add-club">+ Club</button>
          <button class="btn ghost" id="btn-add-release">+ Release</button>
        </div>
        <label>Field Specs (JSON)</label>
        <textarea id="f-fields" rows="8" spellcheck="false"></textarea>
        <div class="row wrap" style="margin:6px 0">
          <button class="btn ghost" id="btn-template-putting">Template: Putting</button>
          <button class="btn ghost" id="btn-template-range">Template: Range</button>
          <button class="btn ghost" id="btn-template-course">Template: Course</button>
        </div>
        <label>Defaults</label>
        <div id="defaults-rows" class="list"></div>
        <div class="row" style="justify-content:flex-end;margin-top:8px">
          <button id="btn-cancel" class="btn ghost">Cancel</button>
          <button id="btn-save" class="btn primary">Save Item</button>
        </div>
      </div>

      <div class="card" style="border:1px dashed rgba(239,68,68,.5)">
        <b>Danger Zone</b>
        <p class="muted">Clear local database (testing only).</p>
        <button id="btn-clear-db" class="btn danger">Clear IndexedDB</button>
      </div>
    </div>

    <!-- SESSION -->
    <div id="view-session" class="hidden">
      <div class="card head">
        <div>
          <h2 id="sess-title">Session</h2>
          <div class="muted" id="sess-sub"></div>
        </div>
        <div class="row">
          <button id="btn-end-session" class="btn danger">End</button>
          <button id="btn-back-home" class="btn ghost">Back</button>
        </div>
      </div>
      <div class="card">
        <div id="session-sections" class="accordion"></div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div id="view-settings" class="hidden">
      <div class="card">
        <h2>My Bag ‚Äî Active Clubs</h2>
        <div id="clubs-list" class="list"></div>
        <div class="row wrap" style="margin-top:8px">
          <input id="club-new" placeholder="e.g., 2H or 60¬∞"/>
          <button id="club-add" class="btn">Add</button>
          <button id="club-reset" class="btn ghost">Reset Defaults</button>
        </div>
      </div>
    </div>
  </div>

  <!-- START MODAL (hidden until user clicks Start) -->
  <div id="start-modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="dialog">
      <h3>Start Practice</h3>
      <div class="row wrap" style="margin-top:6px">
        <div class="grow">
          <label>Choose Plan</label>
          <select id="start-plan"></select>
        </div>
        <div class="grow">
          <label>Note (optional)</label>
          <input id="start-note" placeholder="windy, after work, etc." />
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button id="start-cancel" class="btn ghost">Cancel</button>
        <button id="start-go" class="btn primary">Start</button>
      </div>
    </div>
  </div>

<script>
// =========================
// CONSTANTS (trimmed)
// =========================
const PRIMARY_CHOICES = [
  { key:'score', label:'Points Scored' },
  { key:'attempts_to_complete', label:'Attempts to Complete' },
  { key:'to_par', label:'To Par' },
  { key:'carry_avg', label:'Carry Avg' },
  { key:'', label:'‚Äî None ‚Äî' }
];
const PRIMARY_TEMPLATES = {
  score:{ key:'score', label:'Score', type:'float', unit:'pts', aggregation:'sum', isPrimaryMetric:true },
  attempts_to_complete:{ key:'attempts_to_complete', label:'Attempts to Complete', type:'int', unit:'attempts', aggregation:'avg', isPrimaryMetric:true },
  to_par:{ key:'to_par', label:'To Par', type:'int', unit:'toPar', aggregation:'sum', isPrimaryMetric:true },
  carry_avg:{ key:'carry_avg', label:'Carry Avg', type:'float', unit:'yds', aggregation:'avg', isPrimaryMetric:true }
};
const RELEASE_ENUM = ['R1','R2','R3'];
const SECTIONS = ['Putting','Chipping','Range','Course'];
const SEED_CLUBS = ['Driver','3W','3H','4i','5i','6i','7i','8i','9i','PW','GW','SW','LW','Putter'];

// Minimal Library: top 2 per section
const SEED_LIBRARY = [
  // Putting (Drills)
  { name:'Gate Drill', section:'Putting', contentType:'Drill', defaults:{ attempts:10, distance:6 }, fields:[
    { key:'score', label:'Score', type:'float', unit:'pts', isPrimaryMetric:true, aggregation:'sum' },
    { key:'attempts', label:'Attempts', type:'int', unit:'attempts', required:true, aggregation:'sum' },
    { key:'distance', label:'Distance', type:'float', unit:'ft', aggregation:'avg', role:'context' }
  ]},
  { name:'Circle Drill', section:'Putting', contentType:'Drill', defaults:{ attempts:1, distance:3 }, fields:[
    { key:'attempts_to_complete', label:'Attempts to Complete', type:'int', unit:'attempts', isPrimaryMetric:true, aggregation:'avg' },
    { key:'distance', label:'Distance', type:'float', unit:'ft', aggregation:'avg', role:'context' }
  ]},

  // Chipping (Drills)
  { name:'Chipping Release Drill', section:'Chipping', contentType:'Drill', defaults:{ attempts:10 }, fields:[
    { key:'score', label:'Score', type:'float', unit:'pts', isPrimaryMetric:true, aggregation:'sum' },
    { key:'attempts', label:'Attempts', type:'int', unit:'attempts', required:true, aggregation:'sum' },
    { key:'distance', label:'Distance', type:'float', unit:'yds', aggregation:'avg', role:'context' },
    { key:'club', label:'Club', type:'enum', enumValues: SEED_CLUBS, role:'context', required:true },
    { key:'release', label:'Release Type', type:'enum', enumValues: RELEASE_ENUM, role:'context', required:true }
  ]},
  { name:'Landing Spot Towel Drill', section:'Chipping', contentType:'Drill', defaults:{ attempts:10 }, fields:[
    { key:'score', label:'Score', type:'float', unit:'pts', isPrimaryMetric:true, aggregation:'sum' },
    { key:'attempts', label:'Attempts', type:'int', unit:'attempts', required:true, aggregation:'sum' },
    { key:'distance', label:'Distance', type:'float', unit:'yds', aggregation:'avg', role:'context' },
    { key:'club', label:'Club', type:'enum', enumValues: SEED_CLUBS, role:'context', required:true },
    { key:'release', label:'Release Type', type:'enum', enumValues: RELEASE_ENUM, role:'context', required:true }
  ]},

  // Range (Drills)
  { name:'Wedge Carry', section:'Range', contentType:'Drill', defaults:{ attempts:5 }, fields:[
    { key:'score', label:'Score', type:'float', unit:'pts', isPrimaryMetric:true, aggregation:'sum' },
    { key:'attempts', label:'Attempts', type:'int', unit:'attempts', required:true, aggregation:'sum' },
    { key:'club', label:'Club', type:'enum', enumValues: SEED_CLUBS, role:'context', required:true },
    { key:'distance', label:'Distance', type:'float', unit:'yds', aggregation:'avg', role:'context' },
    { key:'carry_avg', label:'Carry Avg', type:'float', unit:'yds', aggregation:'avg' }
  ]},
  { name:'Start Line', section:'Range', contentType:'Drill', defaults:{ attempts:10 }, fields:[
    { key:'score', label:'Score', type:'float', unit:'pts', isPrimaryMetric:true, aggregation:'sum' },
    { key:'attempts', label:'Attempts', type:'int', unit:'attempts', required:true, aggregation:'sum' },
    { key:'club', label:'Club', type:'enum', enumValues: SEED_CLUBS, role:'context', required:true },
    { key:'distance', label:'Distance', type:'float', unit:'yds', aggregation:'avg', role:'context' }
  ]},

  // Course (Courses)
  { name:'F&G Putting Course', section:'Course', contentType:'Course', defaults:{ holes:18 }, fields:[
    { key:'to_par', label:'To Par', type:'int', unit:'toPar', isPrimaryMetric:true, aggregation:'sum' },
    { key:'holes', label:'Holes', type:'int', unit:'holes', required:true, aggregation:'sum' }
  ]},
  { name:'F&G Loop Course', section:'Course', contentType:'Course', defaults:{ holes:3 }, fields:[
    { key:'to_par', label:'To Par', type:'int', unit:'toPar', isPrimaryMetric:true, aggregation:'sum' },
    { key:'holes', label:'Holes', type:'int', unit:'holes', required:true, aggregation:'sum' }
  ]}
];

// =========================
// Dexie schema & seed
// =========================
const db = new Dexie('golf_practice');
// v1
db.version(1).stores({
  library_items: '++id, name, section, contentType, updatedAt, active',
  plans: '++id, name, isDefault, updatedAt',
  plan_items: '++id, planId, libraryItemId, order',
  sessions: '++id, date, planId',
  entries: '++id, sessionId, libraryItemId, section, contentType',
  clubs: 'id, active',
  settings: 'key'
});

async function seedIfNeeded(){
  const ran = await db.settings.get('seed_v15');
  if(ran) return;
  await db.transaction('rw', db.library_items, db.plans, db.plan_items, db.clubs, db.settings, async ()=>{
    await db.clubs.clear(); await db.clubs.bulkPut(SEED_CLUBS.map(id=>({id,active:true})));
    await db.library_items.clear();
    const now = Date.now();
    for(const item of SEED_LIBRARY){ await db.library_items.add({ ...item, active:true, createdAt:now, updatedAt:now }); }
    const defaultPlanId = await db.plans.add({ name:'Default', isDefault:true, createdAt:now, updatedAt:now });
    const all = await db.library_items.toArray(); const idByName = new Map(all.map(i=>[i.name,i.id]));
    const order = [];
    for(const sec of SECTIONS){ for(const item of SEED_LIBRARY){ if(item.section===sec) order.push(item.name); } }
    let idx=1; for(const n of order){ const id=idByName.get(n); if(id) await db.plan_items.add({ planId: defaultPlanId, libraryItemId: id, order: idx++ }); }
    await db.settings.put({ key:'seed_v15', value:true });
  });
}

// =========================
// Helpers & navigation
// =========================
const $ = s=>document.querySelector(s);
function fmtDate(ts){ const d=new Date(ts); return d.toLocaleString(); }
function show(id){ ['home','library','session','settings'].forEach(v=>$('#view-'+v).classList.add('hidden')); $('#view-'+id).classList.remove('hidden'); if(id==='home') renderRecentSessions(); if(id==='library') renderLibraryList(); if(id==='settings') renderClubs(); }

document.querySelectorAll('[data-nav]').forEach(b=> b.addEventListener('click', ()=> show(b.getAttribute('data-nav'))));

// Primary dropdown helper
function populatePrimary(selectEl, current){ selectEl.innerHTML=''; PRIMARY_CHOICES.forEach(ch=>{ const o=document.createElement('option'); o.value=ch.key; o.textContent=ch.label; selectEl.appendChild(o); }); selectEl.value = current ?? ''; }

// Clubs helper
async function getActiveClubs(){ const arr = await db.clubs.toArray(); return arr.filter(c=>c.active).map(c=>c.id); }

// =========================
// HOME: start / continue / recent
// =========================
$('#btn-start').addEventListener('click', openStartModal);
$('#btn-continue').addEventListener('click', async ()=>{ const last = await db.sessions.orderBy('id').last(); if(!last) return alert('No sessions yet.'); renderSessionView(last.id); });
$('#start-cancel').addEventListener('click', ()=> $('#start-modal').classList.add('hidden'));
$('#start-go').addEventListener('click', async ()=>{ const planId=Number($('#start-plan').value||0); const note=$('#start-note').value.trim(); if(!planId) return alert('Choose a plan'); const id=await db.sessions.add({ date:Date.now(), planId, note, createdAt:Date.now() }); $('#start-modal').classList.add('hidden'); renderSessionView(id); });
async function openStartModal(){ const sel=$('#start-plan'); sel.innerHTML=''; const plans=await db.plans.toArray(); plans.sort((a,b)=> (b.isDefault?1:0)-(a.isDefault?1:0) || a.name.localeCompare(b.name)); for(const p of plans){ const o=document.createElement('option'); o.value=p.id; o.textContent=p.name + (p.isDefault?' (Default)':''); sel.appendChild(o);} $('#start-note').value=''; $('#start-modal').classList.remove('hidden'); }
async function renderRecentSessions(){ const cont=$('#recent-sessions'); cont.innerHTML=''; const sessions=await db.sessions.reverse().limit(5).toArray(); if(!sessions.length){ cont.innerHTML='<div class="muted">No sessions yet.</div>'; return; } for(const s of sessions){ const plan=await db.plans.get(s.planId); const row=document.createElement('div'); row.className='item'; row.innerHTML=`<div><b>${plan?.name||'Plan'}</b> <span class="muted">${fmtDate(s.date)}</span></div><button class="btn ghost" data-open="${s.id}">Open</button>`; cont.appendChild(row);} cont.querySelectorAll('[data-open]').forEach(b=> b.addEventListener('click', ()=> renderSessionView(Number(b.dataset.open)))); }

// =========================
// LIBRARY: list + edit
// =========================
const libList=$('#lib-list'); const fSearch=$('#lib-search'); const fSec=$('#lib-filter-section'); const fType=$('#lib-filter-type');
[fSearch,fSec,fType].forEach(el=> el.addEventListener('input', renderLibraryList));
async function renderLibraryList(){ let items=await db.library_items.toArray(); const q=(fSearch.value||'').toLowerCase(); const sec=fSec.value; const typ=fType.value; items=items.filter(i=>i.active!==false); if(q) items=items.filter(i=>i.name.toLowerCase().includes(q)); if(sec) items=items.filter(i=>i.section===sec); if(typ) items=items.filter(i=>i.contentType===typ); items.sort((a,b)=> SECTIONS.indexOf(a.section)-SECTIONS.indexOf(b.section) || a.name.localeCompare(b.name)); libList.innerHTML=''; if(!items.length){ libList.innerHTML='<div class="muted">No items.</div>'; return; } for(const it of items){ const div=document.createElement('div'); div.className='item'; div.innerHTML=`<div><b>${it.name}</b> <span class="muted">${it.section} ‚Ä¢ ${it.contentType}</span></div><div class="row"><button class="btn ghost" data-edit="${it.id}">Edit</button><button class="btn ghost" data-toggle="${it.id}">${it.active===false?'Activate':'Hide'}</button></div>`; libList.appendChild(div);} libList.querySelectorAll('[data-edit]').forEach(b=> b.addEventListener('click', ()=> loadEditor(parseInt(b.dataset.edit)))); libList.querySelectorAll('[data-toggle]').forEach(b=> b.addEventListener('click', ()=> toggleActive(parseInt(b.dataset.toggle)))); }
async function toggleActive(id){ const it=await db.library_items.get(id); if(!it) return; await db.library_items.update(id,{active:!(it.active!==false),updatedAt:Date.now()}); renderLibraryList(); }

// Editor
const E={ title:$('#editor-title'), name:$('#f-name'), section:$('#f-section'), type:$('#f-type'), active:$('#f-active'), primary:$('#f-primary'), tags:$('#f-tags'), fields:$('#f-fields'), defaults:$('#defaults-rows'), save:$('#btn-save'), cancel:$('#btn-cancel'), addDist:$('#btn-add-distance'), addClub:$('#btn-add-club'), addRel:$('#btn-add-release') };
let editingId=null; populatePrimary(E.primary,'');
function clearEditor(){ editingId=null; E.title.textContent='Add / Edit Item'; E.name.value=''; E.section.value=''; E.type.value=''; E.active.value='true'; E.tags.value=''; populatePrimary(E.primary,''); E.fields.value=''; E.defaults.innerHTML=''; }
$('#btn-add-item').addEventListener('click', ()=>{ clearEditor(); renderDefaultsUI(); window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); });
E.cancel.addEventListener('click', clearEditor);

E.addDist.addEventListener('click', ()=>{ let fs; try{ fs=JSON.parse(E.fields.value||'[]'); }catch{ fs=[]; } if(!fs.find(f=>f.key==='distance')) fs.push({key:'distance',label:'Distance',type:'float',unit:'ft',aggregation:'avg',role:'context'}); E.fields.value=JSON.stringify(fs,null,2); renderDefaultsUI(); });
E.addClub.addEventListener('click', async()=>{ let fs; try{ fs=JSON.parse(E.fields.value||'[]'); }catch{ fs=[]; } if(!fs.find(f=>f.key==='club')){ const clubs=await getActiveClubs(); fs.push({key:'club',label:'Club',type:'enum',enumValues:clubs,role:'context',required:true}); } E.fields.value=JSON.stringify(fs,null,2); renderDefaultsUI(); });
E.addRel.addEventListener('click', ()=>{ let fs; try{ fs=JSON.parse(E.fields.value||'[]'); }catch{ fs=[]; } if(!fs.find(f=>f.key==='release')) fs.push({key:'release',label:'Release Type',type:'enum',enumValues:RELEASE_ENUM,role:'context',required:true}); E.fields.value=JSON.stringify(fs,null,2); renderDefaultsUI(); });

$('#btn-template-putting').addEventListener('click', ()=>{ E.fields.value=JSON.stringify([{key:'score',label:'Score',type:'int',unit:'pts',isPrimaryMetric:true,aggregation:'sum'},{key:'attempts',label:'Attempts',type:'int',unit:'attempts',aggregation:'sum',required:true},{key:'distance',label:'Distance',type:'float',unit:'ft',aggregation:'avg',role:'context'}],null,2); populatePrimary(E.primary,'score'); renderDefaultsUI(); });
$('#btn-template-range').addEventListener('click', async()=>{ const clubs=await getActiveClubs(); E.fields.value=JSON.stringify([{key:'score',label:'Score',type:'int',unit:'pts',isPrimaryMetric:true,aggregation:'sum'},{key:'attempts',label:'Attempts',type:'int',unit:'attempts',aggregation:'sum',required:true},{key:'club',label:'Club',type:'enum',enumValues:clubs,role:'context',required:true},{key:'distance',label:'Distance',type:'float',unit:'yds',aggregation:'avg',role:'context'}],null,2); populatePrimary(E.primary,'score'); renderDefaultsUI(); });
$('#btn-template-course').addEventListener('click', ()=>{ E.fields.value=JSON.stringify([{key:'to_par',label:'To Par',type:'int',unit:'toPar',isPrimaryMetric:true,aggregation:'sum'},{key:'holes',label:'Holes',type:'int',unit:'holes',required:true,aggregation:'sum'}],null,2); populatePrimary(E.primary,'to_par'); renderDefaultsUI(); });

E.fields.addEventListener('input', renderDefaultsUI);
async function renderDefaultsUI(){ E.defaults.innerHTML=''; let fields; try{ fields=JSON.parse(E.fields.value||'[]'); }catch{ fields=[]; } const activeClubs=await getActiveClubs(); for(const f of fields){ const row=document.createElement('div'); row.className='row'; row.dataset.key=f.key; const lab=document.createElement('label'); lab.style.minWidth='140px'; lab.textContent=(f.label||f.key)+' default'; lab.htmlFor='def-'+f.key; row.appendChild(lab); let el; if(f.type==='enum'){ el=document.createElement('select'); const values=(f.key==='club')? activeClubs : (f.enumValues||[]); for(const v of values){ const o=document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o);} } else if(f.type==='int'||f.type==='float'){ el=document.createElement('input'); el.type='number'; el.step=(f.type==='float'?'0.1':'1'); } else { el=document.createElement('input'); el.type='text'; } el.className='def'; el.id='def-'+f.key; row.appendChild(el); E.defaults.appendChild(row);} }
function gatherDefaults(){ const obj={}; E.defaults.querySelectorAll('.def').forEach(el=>{ const k=el.id.replace('def-',''); let v=el.value; if(el.type==='number') v = el.value===''?null:Number(el.value); obj[k]=v; }); return obj; }

async function loadEditor(id){ const it=await db.library_items.get(id); if(!it) return; editingId=id; E.title.textContent='Editing: '+it.name; E.name.value=it.name; E.section.value=it.section; E.type.value=it.contentType; E.active.value=(it.active!==false).toString(); E.tags.value=(it.tags||[]).join(', '); E.fields.value=JSON.stringify(it.fields||[],null,2); populatePrimary(E.primary,(it.fields||[]).find(f=>f.isPrimaryMetric)?.key||''); await renderDefaultsUI(); const defs=it.defaults||{}; for(const [k,v] of Object.entries(defs)){ const el=$('#def-'+k); if(el) el.value=v; } window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); }

E.save.addEventListener('click', async()=>{
  const name=E.name.value.trim(); const section=E.section.value; const contentType=E.type.value; const active=E.active.value==='true'; const tags=E.tags.value.split(',').map(s=>s.trim()).filter(Boolean); const primaryKey=E.primary.value.trim();
  if(!name) return alert('Name required'); if(!section) return alert('Section required'); if(!contentType) return alert('Type required');
  let fields; try{ fields=JSON.parse(E.fields.value||'[]'); }catch{ return alert('Invalid Field Specs JSON'); }
  if(primaryKey){ if(!fields.find(f=>f.key===primaryKey)) fields.push({...PRIMARY_TEMPLATES[primaryKey]}); fields = fields.map(f=> ({...f, isPrimaryMetric: f.key===primaryKey })); }
  else { fields = fields.map(f=> ({...f, isPrimaryMetric:false })); }
  const defaults = gatherDefaults();
  const dupe = await db.library_items.filter(x=> x.name.toLowerCase()===name.toLowerCase() && x.id!==editingId).first(); if(dupe) return alert('Duplicate name');
  const payload={ name, section, contentType, tags, active, fields, defaults, updatedAt:Date.now() };
  if(editingId){ await db.library_items.update(editingId, payload); }
  else { payload.createdAt=Date.now(); await db.library_items.add(payload); }
  clearEditor(); renderLibraryList(); alert('Saved');
});

// =========================
// SETTINGS: clubs
// =========================
async function renderClubs(){ const cont=$('#clubs-list'); cont.innerHTML=''; const clubs=(await db.clubs.toArray()).sort((a,b)=> a.id.localeCompare(b.id)); if(!clubs.length){ cont.innerHTML='<div class="muted">No clubs.</div>'; return; } for(const c of clubs){ const row=document.createElement('div'); row.className='item'; row.innerHTML=`<div><b>${c.id}</b> <span class="muted">${c.active?'Active':'Hidden'}</span></div><div class="row"><button class="btn ghost" data-toggle="${c.id}">${c.active?'Deactivate':'Activate'}</button><button class="btn ghost" data-remove="${c.id}">Remove</button></div>`; cont.appendChild(row);} cont.querySelectorAll('[data-toggle]').forEach(b=> b.addEventListener('click', async()=>{ const id=b.dataset.toggle; const c=await db.clubs.get(id); if(!c) return; await db.clubs.put({id, active:!c.active}); renderClubs(); })); cont.querySelectorAll('[data-remove]').forEach(b=> b.addEventListener('click', async()=>{ const id=b.dataset.remove; await db.clubs.delete(id); renderClubs(); })); }
$('#club-add').addEventListener('click', async()=>{ const id=($('#club-new').value||'').trim(); if(!id) return; await db.clubs.put({id,active:true}); $('#club-new').value=''; renderClubs(); });
$('#club-reset').addEventListener('click', async()=>{ if(!confirm('Reset to default set?')) return; await db.clubs.clear(); await db.clubs.bulkPut(SEED_CLUBS.map(id=>({id,active:true}))); renderClubs(); });

// =========================
// SESSION: forms & entries
// =========================
$('#btn-back-home').addEventListener('click', ()=> show('home'));
$('#btn-end-session').addEventListener('click', async()=>{ if(!currentSessionId) return; const s=await db.sessions.get(currentSessionId); if(!s) return; s.endedAt=Date.now(); await db.sessions.put(s); show('home'); });
let currentSessionId=null;

async function renderSessionView(sessionId){
  currentSessionId=sessionId;
  const s=await db.sessions.get(sessionId); const plan=await db.plans.get(s.planId);
  $('#sess-title').textContent=plan?.name || 'Session';
  $('#sess-sub').textContent=fmtDate(s.date)+(s.note? ' ¬∑ '+s.note:'');

  // Gather items in plan
  const planItems = await db.plan_items.where('planId').equals(s.planId).toArray(); planItems.sort((a,b)=> a.order-b.order);
  const items=[]; for(const pi of planItems){ const it=await db.library_items.get(pi.libraryItemId); if(it && it.active!==false) items.push(it); }

  const container=$('#session-sections'); container.innerHTML='';
  const bySec = {}; for(const sec of SECTIONS) bySec[sec]=[]; for(const it of items){ bySec[it.section].push(it); }
  for(const sec of SECTIONS){ const list=bySec[sec]; if(!list.length) continue; const secDiv=document.createElement('div'); secDiv.className='section'; secDiv.innerHTML=`<div class="head"><b>${sec}</b><span class="muted"> ${list.length} items</span></div><div class="body"></div>`; const body=secDiv.querySelector('.body'); for(const it of list){ body.appendChild(renderSessionItemCard(s.id,it)); } secDiv.querySelector('.head').addEventListener('click', ()=> body.classList.toggle('hidden')); container.appendChild(secDiv); }
  show('session');
}

function renderSessionItemCard(sessionId,item){ const wrap=document.createElement('div'); wrap.className='item'; wrap.innerHTML=`<div><b>${item.name}</b> <span class="muted">${item.contentType}</span></div><button class="btn" data-log>Log</button>`; const logBtn=wrap.querySelector('[data-log]'); logBtn.addEventListener('click', async()=>{ const form=await buildEntryForm(sessionId,item); wrap.after(form); form.scrollIntoView({behavior:'smooth',block:'start'}); }); // show recent entries under card
  const entriesDiv=document.createElement('div'); entriesDiv.style.marginTop='6px'; wrap.appendChild(entriesDiv); (async()=>{ const entries=await db.entries.where({sessionId, libraryItemId:item.id}).toArray(); if(entries.length){ const list=document.createElement('div'); list.className='list'; for(const e of entries){ list.appendChild(renderEntrySummary(e,item)); } entriesDiv.appendChild(list);} })(); return wrap; }

function renderEntrySummary(entry,item){ const d=document.createElement('div'); d.className='item'; const pk=(item.fields||[]).find(f=>f.isPrimaryMetric)?.key; let main=pk && entry.data ? entry.data[pk] : undefined; if(main===undefined && entry.data){ if('score' in entry.data) main=entry.data.score; else if('attempts_to_complete' in entry.data) main=entry.data.attempts_to_complete; else if('to_par' in entry.data) main=entry.data.to_par; else if('carry_avg' in entry.data) main=entry.data.carry_avg; }
  d.innerHTML=`<div><b>${item.name}</b> <span class="muted">${main!==undefined?'Primary: '+main:'Logged'}</span></div><span class="muted">${new Date(entry.endedAt||entry.startedAt||Date.now()).toLocaleTimeString()}</span>`; return d; }

async function buildEntryForm(sessionId,item){ const formWrap=document.createElement('div'); formWrap.className='card'; const formId=`f-${sessionId}-${item.id}-${Math.random().toString(36).slice(2)}`; formWrap.innerHTML=`<h3>Log: ${item.name}</h3><form id="${formId}"></form><div class="row" style="justify-content:flex-end;margin-top:6px"><button class="btn ghost" data-cancel>Cancel</button><button class="btn primary" data-save>Save</button></div>`; const form=formWrap.querySelector('form'); const defaults=item.defaults||{}; const fields=(item.fields||[]);
  const activeClubs=await getActiveClubs();
  for(const f of fields){ const gid=`${formId}-${f.key}`; const g=document.createElement('div'); g.style.marginTop='6px'; const lab=document.createElement('label'); lab.textContent=f.label||f.key; lab.setAttribute('for',gid); let input; if(f.type==='enum'){ input=document.createElement('select'); const opts=(f.key==='club')? activeClubs : (f.enumValues||[]); for(const v of opts){ const o=document.createElement('option'); o.value=v; o.textContent=v; input.appendChild(o);} if(defaults[f.key]!==undefined) input.value=defaults[f.key]; }
    else if(f.type==='int'||f.type==='float'){ input=document.createElement('input'); input.type='number'; input.step=(f.type==='float'?'0.1':'1'); if(defaults[f.key]!==undefined) input.value=defaults[f.key]; }
    else if(f.type==='bool'){ input=document.createElement('input'); input.type='checkbox'; input.checked=Boolean(defaults[f.key]); }
    else if(f.type==='text' || f.role==='note'){ input=document.createElement('textarea'); input.rows=3; if(defaults[f.key]!==undefined) input.value=defaults[f.key]; }
    else { input=document.createElement('input'); input.type='text'; if(defaults[f.key]!==undefined) input.value=defaults[f.key]; }
    input.id=gid; input.name=f.key; if(f.required) input.required=true; input.dataset.type=f.type; g.appendChild(lab); g.appendChild(input); form.appendChild(g); }
  formWrap.querySelector('[data-cancel]').addEventListener('click', ()=> formWrap.remove());
  formWrap.querySelector('[data-save]').addEventListener('click', async (e)=>{ e.preventDefault(); const data={}; for(const el of form.elements){ if(!el.name) continue; let v=el.value; const t=el.dataset.type; if(el.type==='checkbox') v=el.checked; else if(t==='int') v = el.value===''?null:Number.parseInt(el.value,10); else if(t==='float') v = el.value===''?null:Number.parseFloat(el.value); data[el.name]=v; } for(const f of fields){ if(f.required && (data[f.key]===undefined||data[f.key]===null||data[f.key]==='')) return alert('Missing required: '+(f.label||f.key)); }
    await db.entries.add({ sessionId, libraryItemId:item.id, section:item.section, contentType:item.contentType, data, startedAt:Date.now(), endedAt:Date.now() }); formWrap.remove(); renderSessionView(sessionId); });
  return formWrap; }

// =========================
// Danger: clear DB
// =========================
$('#btn-clear-db').addEventListener('click', async ()=>{ if(!confirm('Remove ALL local data?')) return; await db.delete(); location.reload(); });

// =========================
// INIT ‚Äî land on Home; modal hidden unless button
// =========================
async function init(){ await seedIfNeeded(); show('home'); const m=document.getElementById('start-modal'); if(m) m.classList.add('hidden'); }
init();
</script>
</body>
</html>