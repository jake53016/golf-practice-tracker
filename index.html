<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Golf Practice Tracker – Dynamic Plans</title>
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root{--bg:#0b1220;--card:#101829;--ink:#e5ecff;--muted:#9db4ff;--accent:#38bdf8;--ok:#22c55e;--bad:#ef4444;--warn:#f59e0b}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:linear-gradient(180deg,#0b1220,#0f172a); color:var(--ink)}
    a{color:var(--accent)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;position:sticky;top:0;background:rgba(11,18,32,.85);backdrop-filter:blur(6px);padding:10px 16px;border-bottom:1px solid #1f2a44;z-index:5}
    .title{display:flex;gap:10px;align-items:center}
    nav{display:flex;gap:8px}
    .tab{border:1px solid #1f2a44;background:var(--card);color:var(--ink);padding:8px 12px;border-radius:12px;cursor:pointer}
    .tab.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(56,189,248,.25) inset}
    .grid{display:grid;gap:12px}
    .cards{grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .card{background:var(--card);border:1px solid #1f2a44;border-radius:16px;padding:14px}
    h1,h2,h3{margin:0 0 8px}
    h1{font-size:22px}
    h2{font-size:18px;color:var(--muted)}
    h3{font-size:16px;color:var(--muted)}
    label{font-size:13px;color:#c7d2fe}
    input,textarea,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #2a3558;background:#0c1427;color:var(--ink);outline:none}
    input[type=number]{appearance:textfield}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>div{flex:1 1 220px}
    .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;background:var(--accent);border:0;color:#052338;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid #1f2a44;color:var(--ink)}
    .btn.warn{background:var(--bad);color:white}
    .small{font-size:12px;color:#9db4ff}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2a44;padding:8px 6px;text-align:left;font-size:13px;vertical-align:top}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #223055;color:#c7d2fe;font-size:12px}
    .section{border-top:1px dashed #223055;padding-top:8px;margin-top:8px}
    .flex-between{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .list{display:flex;flex-wrap:wrap;gap:8px}
    .chip{padding:6px 10px;border:1px solid #243257;border-radius:999px}
    .chip.sel{border-color:var(--accent);box-shadow:0 0 0 2px rgba(56,189,248,.2) inset}
    .hide{display:none}
  </style>
</head>
<body>
  <header>
    <div class="title">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M20 21H4m4.5-5.5L20 3l-5.5 11.5L9 15.5Z" stroke="#38bdf8" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="6" cy="18" r="2" stroke="#38bdf8"/></svg>
      <div>
        <h1>Golf Practice Tracker</h1>
        <div class="small">Dynamic Plans • Drill Library • Stats on-device</div>
      </div>
    </div>
    <nav>
      <button class="tab active" data-tab="plan">Plan</button>
      <button class="tab" data-tab="log">Log</button>
      <button class="tab" data-tab="stats">Stats</button>
    </nav>
  </header>

  <main class="wrap">
    <!-- PLAN TAB -->
    <section id="plan" class="grid">
      <div class="card">
        <div class="flex-between">
          <h2>Plan Builder</h2>
          <div class="row" style="flex:0 1 520px">
            <div>
              <label>Saved Plans</label>
              <select id="planPicker"></select>
            </div>
            <div style="flex:0 0 auto;align-self:flex-end;display:flex;gap:8px">
              <!-- Load button removed (auto-load on change) -->
              <button class="btn ghost" id="savePlanBtn">Save</button>
              <button class="btn warn" id="deletePlanBtn">Delete</button>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="row">
            <div>
              <label>Plan Name</label>
              <input id="planName" placeholder="e.g., Short Game Focus" />
            </div>
            <div>
              <label>Today’s Focus (optional)</label>
              <input id="planFocus" placeholder="e.g., Speed control, Up & Down %" />
            </div>
          </div>
        </div>

        <div class="section">
          <h3>Pick Drills</h3>
          <p class="small">Tap to include drills in this plan. You can edit or create drills below.</p>
          <div id="pickers"></div>
        </div>

        <div class="section">
          <h3>Drill Library</h3>
          <p class="small">Add or edit drills. Types:<br/>• <b>Made/Attempts</b> (ma) → stores m/t and %<br/>• <b>Points/Max</b> (pm) → stores points/max and %<br/>• <b>Note</b> (note) → free text per session (not in % stats)</p>
          <div id="library"></div>
          <div style="margin-top:10px"><button class="btn" id="addDrillBtn">Add Drill</button></div>
        </div>
      </div>
    </section>

    <!-- LOG TAB -->
    <section id="log" class="grid hide">
      <div class="card">
        <div class="flex-between">
          <h2>Log Session</h2>
          <div class="small">Active Plan: <span id="activePlanName">–</span></div>
        </div>
        <div class="row">
          <div>
            <label>Date</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label>Notes</label>
            <input id="notes" placeholder="What went well? What to adjust next time?" />
          </div>
        </div>
      </div>

      <div id="logForm"></div>

      <div class="card">
        <div style="display:flex;gap:8px">
          <button class="btn" id="saveSession">Save Session</button>
          <button class="btn ghost" id="clearForm">Clear Form</button>
        </div>
      </div>
    </section>

    <!-- STATS TAB -->
    <section id="stats" class="grid hide">
      <div class="grid cards">
        <div class="card">
          <h2>Stats</h2>

          <div class="section">
            <label>Filter by Plan</label>
            <select id="statsPlanFilter"></select>
          </div>

          <div class="section" style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn ghost" id="exportBtn">Export JSON</button>
            <label class="btn ghost" for="importFile" style="cursor:pointer">
              Import
              <input id="importFile" type="file" accept="application/json" style="display:none"/>
            </label>
            <button class="btn warn" id="resetAll">Reset All</button>
          </div>

          <div id="statsSummary" class="row"></div>
        </div>
      </div>

      <div class="card">
        <h2>Sessions</h2>
        <table id="tbl">
          <thead>
            <tr>
              <th>Date</th>
              <th>Plan</th>
              <th>Drills</th>
              <th>Notes</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
    
      // Sessions table
      recent.forEach(s=>{
        const tr = el('tr');
        const drillsHTML = Object.entries(s.measures).map(([id,val])=>{
          const d = getDrill(id); if(!d) return '';
          if(val.type==='note'){ return `<div><b>${d.name}</b>: ${val.n}</div>`; }
          const p = (val.t>0)? Math.round(val.m/val.t*100)+'%' : '–';
          return `<div><b>${d.name}</b>: ${val.m}/${val.t} (${p})</div>`;
        }).join('');
        tr.innerHTML = `
          <td><span class="pill">${s.date}</span></td>
          <td>${s.planName||''}</td>
          <td>${drillsHTML}</td>
          <td class="small">${(s.notes||'').slice(0,120)}</td>
          <td><button class="btn ghost" data-del="${s.id}">Delete</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('button[data-del]').forEach(b=> b.onclick = ()=>{
        const id = b.getAttribute('data-del');
        sessions = sessions.filter(x=>x.id!==id);
        store.save(store.keySessions, sessions);
        computeAndRender(sel.value);
      });
    }

    sel.onchange = ()=> computeAndRender(sel.value);
    computeAndRender('');
  }

  // Export / Import / Reset
  document.getElementById('exportBtn').onclick = ()=>{
    const data = {
      drills, plans, activePlanId, sessions
    };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'golf_practice_backup_v2.json';
    a.click();
  };
  document.getElementById('importFile').addEventListener('change',(e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        if(Array.isArray(data.drills)) drills = data.drills;
        if(Array.isArray(data.plans)) plans = data.plans;
        if(data.activePlanId) activePlanId = data.activePlanId;
        if(Array.isArray(data.sessions)) sessions = data.sessions;
        store.save(store.keyDrills, drills);
        store.save(store.keyPlans, plans);
        localStorage.setItem(store.keyActivePlan, activePlanId);
        store.save(store.keySessions, sessions);
        alert('Import complete.');
        renderPlan(); renderLog(); renderStats();
      }catch(err){ alert('Import failed. Invalid file.'); }
    };
    reader.readAsText(file);
  });
  document.getElementById('resetAll').onclick = ()=>{
    if(!confirm('Delete ALL plans, drills, and sessions on this device?')) return;
    localStorage.removeItem(store.keyDrills);
    localStorage.removeItem(store.keyPlans);
    localStorage.removeItem(store.keyActivePlan);
    localStorage.removeItem(store.keySessions);
    drills = defaultDrills.slice();
    plans = [{id:'plan_std', name:'Standard Session', focus:'', drills:['put_gate','put_circle','put_lag','chip_towel','chip_updown','rng_gir','rng_iron','rng_drv']}];
    activePlanId = plans[0].id;
    sessions = [];
    renderPlan(); renderLog(); renderStats();
  };

  // initial render
  renderPlan();
  </script>
</body>
</html>