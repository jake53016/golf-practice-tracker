<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Golf Practice ‚Äî Seeded Template v1.1</title>
  <!-- Dexie (IndexedDB) -->
  <script src="https://unpkg.com/dexie@latest/dist/dexie.min.js"></script>
  <style>
    :root{
      --bg:#0e1116; --card:#141922; --muted:#8aa0b6; --text:#e8eef6; --accent:#60a5fa; --accent-2:#22c55e; --danger:#ef4444; --warn:#f59e0b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Arial}
    a{color:inherit;text-decoration:none}
    button{cursor:pointer}
    .container{max-width:980px;margin:0 auto;padding:20px}
    .grid{display:grid;gap:16px}
    .grid-cols-2{grid-template-columns:1fr 1fr}
    @media(max-width:720px){.grid-cols-2{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .grow{flex:1}
    .muted{color:var(--muted)}
    .pill{display:inline-block;background:rgba(255,255,255,.06);padding:4px 10px;border-radius:999px;font-size:12px;margin-right:8px}
    .btn{background:#1f2937;color:#fff;border:1px solid rgba(255,255,255,.1);padding:10px 14px;border-radius:12px}
    .btn.primary{background:var(--accent);border-color:transparent}
    .btn.success{background:var(--accent-2)}
    .btn.danger{background:var(--danger)}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.15)}
    .btn.icon{display:inline-flex;align-items:center;gap:8px}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#111521;color:var(--text)}
    label{display:block;font-weight:600;margin:6px 0 6px}
    .list{display:grid;gap:10px}
    .item{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;background:#0f1420;border:1px solid rgba(255,255,255,.08)}
    .item .meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:rgba(255,255,255,.06);padding:2px 6px;border-radius:8px;font-size:12px}
    .tag{font-size:12px;border:1px dashed rgba(255,255,255,.25);padding:2px 8px;border-radius:999px}
    .hidden{display:none}
    .danger-zone{border:1px dashed rgba(239,68,68,.5);padding:12px;border-radius:12px}
    .hr{height:1px;background:rgba(255,255,255,.1);margin:14px 0}
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <div class="row wrap" style="margin-bottom:16px">
      <h1 class="grow">üèåÔ∏è‚Äç‚ôÇÔ∏è Golf Practice</h1>
      <div class="row" role="toolbar">
        <button class="btn ghost" data-nav="home">Home</button>
        <button class="btn ghost" data-nav="library">Library</button>
        <button class="btn ghost" data-nav="plans" disabled>Plans</button>
        <button class="btn ghost" data-nav="stats" disabled>Stats</button>
        <button class="btn ghost" data-nav="settings" disabled>Settings</button>
      </div>
    </div>

    <!-- VIEWS -->
    <div id="view-home" class="grid grid-cols-2">
      <div class="card">
        <h2>Quick Actions</h2>
        <div class="row wrap" style="margin-top:10px">
          <button class="btn primary" disabled title="Session UI coming next">Start Practice</button>
          <button class="btn" disabled>Continue Last</button>
          <button class="btn" disabled>View Stats</button>
        </div>
        <div class="hr"></div>
        <div>
          <span class="pill">Offline‚Äëfirst</span>
          <span class="pill">IndexedDB</span>
          <span class="pill">Mobile‚Äëfriendly</span>
          <span class="pill" title="Seeded from your spreadsheet (hardcoded, no Excel reads)">Seeded Defaults</span>
        </div>
      </div>

      <div class="card">
        <h2>Recent Sessions</h2>
        <div class="muted">(Coming soon) Your last 5 sessions will appear here.</div>
      </div>

      <div class="card">
        <h2>Favorites</h2>
        <div class="muted">(Coming soon) Pin drills/games for one‚Äëtap logging.</div>
      </div>

      <div class="card">
        <h2>Tips</h2>
        <p class="muted">Add or edit items in <b>Library</b>. Defaults you set there will prefill your log sheets.</p>
      </div>
    </div>

    <!-- LIBRARY VIEW -->
    <div id="view-library" class="hidden">
      <div class="card">
        <div class="toolbar">
          <h2 class="grow">Library</h2>
          <div class="row">
            <input id="lib-search" placeholder="Search by name‚Ä¶" />
            <select id="lib-filter-section">
              <option value="">All Sections</option>
              <option>Putting</option>
              <option>Chipping</option>
              <option>Range</option>
              <option>Course</option>
            </select>
            <select id="lib-filter-type">
              <option value="">All Types</option>
              <option>Drill</option>
              <option>Game</option>
              <option>Course</option>
              <option>Note</option>
            </select>
            <button id="btn-add-item" class="btn success icon">‚ûï <span>Add Item</span></button>
          </div>
        </div>

        <div id="lib-list" class="list"></div>
      </div>

      <div class="card" id="lib-editor" aria-live="polite">
        <h3 id="editor-title">Add / Edit Item</h3>
        <div class="grid grid-cols-2">
          <div>
            <label>Name</label>
            <input id="f-name" placeholder="e.g., Gate Drill" />
          </div>
          <div>
            <label>Section</label>
            <select id="f-section">
              <option value="">‚Äî Select ‚Äî</option>
              <option>Putting</option>
              <option>Chipping</option>
              <option>Range</option>
              <option>Course</option>
            </select>
          </div>
          <div>
            <label>Type</label>
            <select id="f-type">
              <option value="">‚Äî Select ‚Äî</option>
              <option>Drill</option>
              <option>Game</option>
              <option>Course</option>
              <option>Note</option>
            </select>
          </div>
          <div>
            <label>Tags (comma separated)</label>
            <input id="f-tags" placeholder="lag, short putts" />
          </div>
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label>Active</label>
              <select id="f-active">
                <option value="true">Yes</option>
                <option value="false">No (hide)</option>
              </select>
            </div>
            <div>
              <label>Primary Metric Key</label>
              <select id="f-primary">
                <option value="">‚Äî None ‚Äî</option>
              </select>
            </div>
          </div>
          <div class="grid" style="grid-column:1/-1">
            <label>Defaults (key ‚Üí value)</label>
            <div class="row wrap" id="defaults-rows"></div>
            <div style="margin-top:8px"><button id="btn-add-default" class="btn ghost">+ Add Default</button></div>
          </div>
          <div style="grid-column:1/-1">
            <label>Field Specs (JSON)</label>
            <textarea id="f-fields" rows="10" spellcheck="false" placeholder='[
  { "key":"score", "label":"Score", "type":"int", "unit":"pts", "isPrimaryMetric":true, "aggregation":"sum" },
  { "key":"attempts", "label":"Attempts", "type":"int", "unit":"attempts", "aggregation":"sum" }
]'></textarea>
            <div class="row wrap" style="margin-top:8px">
              <button class="btn ghost" id="btn-template-putting">Template: Putting Drill</button>
              <button class="btn ghost" id="btn-template-range">Template: Range Drill</button>
              <button class="btn ghost" id="btn-template-course">Template: Course</button>
            </div>
          </div>
        </div>
        <div class="row" style="margin-top:12px;justify-content:flex-end;gap:10px">
          <button id="btn-cancel" class="btn ghost">Cancel</button>
          <button id="btn-save" class="btn primary">Save Item</button>
        </div>
      </div>

      <div class="card danger-zone">
        <b>Danger Zone</b>
        <p class="muted">Clear local database (all data). Useful while testing.</p>
        <button id="btn-clear-db" class="btn danger">Clear IndexedDB</button>
      </div>
    </div>
  </div>

  <script>
  // ------------------------------
  // SEEDS ‚Äî Generated from your spreadsheet (hardcoded; no Excel reads)
  // ------------------------------
  const SEED_CLUBS = [
    "Driver","3W","3H","4i","5i","6i","7i","8i","9i","PW","GW","SW","LW","Putter"
  ];

  const SECTIONS = ["Putting","Chipping","Range","Course"];

  const SEED_LIBRARY = [
    // Putting
    { name:"Gate Drill", section:"Putting", contentType:"Drill", defaults:{ attempts:10, distance:6 }, fields:[
      { key:"score", label:"Score", type:"float", unit:"pts", isPrimaryMetric:true, aggregation:"sum" },
      { key:"attempts", label:"Attempts", type:"int", unit:"attempts", required:true, aggregation:"sum" },
      { key:"distance", label:"Distance", type:"float", unit:"ft", aggregation:"avg", role:"context" }
    ]},
    { name:"Circle Drill", section:"Putting", contentType:"Drill", defaults:{ attempts:1, distance:3 }, fields:[
      { key:"attempts_to_complete", label:"Attempts to Complete", type:"int", unit:"attempts", isPrimaryMetric:true, aggregation:"avg" },
      { key:"distance", label:"Distance", type:"float", unit:"ft", aggregation:"avg", role:"context" }
    ]},
    { name:"Lag Putting Drill", section:"Putting", contentType:"Drill", defaults:{ attempts:5 }, fields:[
      { key:"score", label:"Score", type:"float", unit:"pts", isPrimaryMetric:true, aggregation:"sum" },
      { key:"attempts", label:"Attempts", type:"int", unit:"attempts", required:true, aggregation:"sum" },
      { key:"distance", label:"Distance", type:"float", unit:"ft", aggregation:"avg", role:"context" }
    ]},
    { name:"2 Putt Game", section:"Putting", contentType:"Game", defaults:{ attempts:1 }, fields:[
      { key:"attempts_to_complete", label:"Attempts to Complete", type:"int", unit:"attempts", isPrimaryMetric:true, aggregation:"avg" }
    ]},

    // Chipping (Short Game)
    { name:"Chipping Release Drill", section:"Chipping", contentType:"Drill", defaults:{ attempts:10 }, fields:[
      { key:"score", label:"Score", type:"float", unit:"pts", isPrimaryMetric:true, aggregation:"sum" },
      { key:"attempts", label:"Attempts", type:"int", unit:"attempts", required:true, aggregation:"sum" },
      { key:"distance", label:"Distance", type:"float", unit:"yds", aggregation:"avg", role:"context" },
      { key:"club", label:"Club", type:"enum", enumValues: SEED_CLUBS, role:"context", required:true },
      { key:"release", label:"Release Type", type:"enum", enumValues:["R1","R2","R3"], role:"context", required:true }
    ]},
    { name:"Landing Spot Towel  Drill", section:"Chipping", contentType:"Drill", defaults:{ attempts:10 }, fields:[
      { key:"score", label:"Score", type:"float", unit:"pts", isPrimaryMetric:true, aggregation:"sum" },
      { key:"attempts", label:"Attempts", type:"int", unit:"attempts", required:true, aggregation:"sum" },
      { key:"distance", label:"Distance", type:"float", unit:"yds", aggregation:"avg", role:"context" },
      { key:"club", label:"Club", type:"enum", enumValues: SEED_CLUBS, role:"context", required:true },
      { key:"release", label:"Release Type", type:"enum", enumValues:["R1","R2","R3"], role:"context", required:true }
    ]},
    { name:"Up & Down Game", section:"Chipping", contentType:"Game", defaults:{ attempts:9 }, fields:[
      { key:"attempts_to_complete", label:"Attempts to Complete", type:"int", unit:"attempts", isPrimaryMetric:true, aggregation:"avg" },
      { key:"club", label:"Club", type:"enum", enumValues: SEED_CLUBS, role:"context", required:true },
      { key:"release", label:"Release Type", type:"enum", enumValues:["R1","R2","R3"], role:"context", required:true }
    ]},

    // Range
    { name:"Wedge Carry", section:"Range", contentType:"Drill", defaults:{ attempts:5 }, fields:[
      { key:"score", label:"Score", type:"float", unit:"pts", isPrimaryMetric:true, aggregation:"sum" },
      { key:"attempts", label:"Attempts", type:"int", unit:"attempts", required:true, aggregation:"sum" },
      { key:"club", label:"Club", type:"enum", enumValues: SEED_CLUBS, role:"context", required:true },
      { key:"distance", label:"Distance", type:"float", unit:"yds", aggregation:"avg", role:"context" },
      { key:"carry_avg", label:"Carry Avg", type:"float", unit:"yds", aggregation:"avg" }
    ]},
    { name:"Fades", section:"Range", contentType:"Drill", defaults:{ attempts:5 }, fields:[
      { key:"score", label:"Score", type:"float", unit:"pts", isPrimaryMetric:true, aggregation:"sum" },
      { key:"attempts", label:"Attempts", type:"int", unit:"attempts", required:true, aggregation:"sum" },
      { key:"club", label:"Club", type:"enum", enumValues: SEED_CLUBS, role:"context", required:true },
      { key:"distance", label:"Distance", type:"float", unit:"yds", aggregation:"avg", role:"context" }
    ]},
    { name:"Draws", section:"Range", contentType:"Drill", defaults:{ attempts:5 }, fields:[
      { key:"score", label:"Score", type:"float", unit:"pts", isPrimaryMetric:true, aggregation:"sum" },
      { key:"attempts", label:"Attempts", type:"int", unit:"attempts", required:true, aggregation:"sum" },
      { key:"club", label:"Club", type:"enum", enumValues: SEED_CLUBS, role:"context", required:true },
      { key:"distance", label:"Distance", type:"float", unit:"yds", aggregation:"avg", role:"context" }
    ]},
    { name:"Start Line", section:"Range", contentType:"Drill", defaults:{ attempts:10 }, fields:[
      { key:"score", label:"Score", type:"float", unit:"pts", isPrimaryMetric:true, aggregation:"sum" },
      { key:"attempts", label:"Attempts", type:"int", unit:"attempts", required:true, aggregation:"sum" },
      { key:"club", label:"Club", type:"enum", enumValues: SEED_CLUBS, role:"context", required:true },
      { key:"distance", label:"Distance", type:"float", unit:"yds", aggregation:"avg", role:"context" }
    ]},
    { name:"GIR Iron Game", section:"Range", contentType:"Game", defaults:{ attempts:10 }, fields:[
      { key:"score", label:"Score", type:"float", unit:"pts", isPrimaryMetric:true, aggregation:"sum" },
      { key:"attempts", label:"Attempts", type:"int", unit:"attempts", required:true, aggregation:"sum" },
      { key:"club", label:"Club", type:"enum", enumValues: SEED_CLUBS, role:"context" }
    ]},

    // Course
    { name:"F&G Putting Course", section:"Course", contentType:"Course", defaults:{ holes:18 }, fields:[
      { key:"to_par", label:"To Par", type:"int", unit:"toPar", isPrimaryMetric:true, aggregation:"sum" },
      { key:"holes", label:"Holes", type:"int", unit:"holes", required:true, aggregation:"sum" }
    ]},
    { name:"F&G Loop Course", section:"Course", contentType:"Course", defaults:{ holes:3 }, fields:[
      { key:"to_par", label:"To Par", type:"int", unit:"toPar", isPrimaryMetric:true, aggregation:"sum" },
      { key:"holes", label:"Holes", type:"int", unit:"holes", required:true, aggregation:"sum" }
    ]},
    { name:"Trackman Course", section:"Course", contentType:"Course", defaults:{ holes:18 }, fields:[
      { key:"to_par", label:"To Par", type:"int", unit:"toPar", isPrimaryMetric:true, aggregation:"sum" },
      { key:"holes", label:"Holes", type:"int", unit:"holes", required:true, aggregation:"sum" }
    ]},

    // Mental Game ‚Äî Notes (available everywhere; not in Default plan)
    { name:"2-Step Reset", section:"Range", contentType:"Note", defaults:{}, fields:[ { key:"note", label:"Note", type:"text", role:"note" } ], appliesTo:{ sections:["Putting","Chipping","Range","Course"] }, tags:["mental"] },
    { name:"Think Box - Play Box", section:"Range", contentType:"Note", defaults:{}, fields:[ { key:"note", label:"Note", type:"text", role:"note" } ], appliesTo:{ sections:["Putting","Chipping","Range","Course"] }, tags:["mental"] },
    { name:"One Cue", section:"Range", contentType:"Note", defaults:{}, fields:[ { key:"note", label:"Note", type:"text", role:"note" } ], appliesTo:{ sections:["Putting","Chipping","Range","Course"] }, tags:["mental"] },
    { name:"Breathing", section:"Range", contentType:"Note", defaults:{}, fields:[ { key:"note", label:"Note", type:"text", role:"note" } ], appliesTo:{ sections:["Putting","Chipping","Range","Course"] }, tags:["mental"] }
  ];

  // ------------------------------
  // Dexie schema & setup
  // ------------------------------
  const db = new Dexie('golf_practice');
  db.version(1).stores({
    library_items: '++id, name, section, contentType, updatedAt, active',
    plans: '++id, name, isDefault, updatedAt',
    plan_items: '++id, planId, libraryItemId, order',
    sessions: '++id, date, planId',
    entries: '++id, sessionId, libraryItemId, section, contentType',
    clubs: 'id',
    settings: 'key'
  });

  // Seed default data if first run
  async function seedIfNeeded(){
    const hasRun = await db.settings.get('seed_template_v1_1');
    if(hasRun) return;

    await db.transaction('rw', db.library_items, db.plans, db.plan_items, db.clubs, db.settings, async () => {
      // Clubs
      await db.clubs.clear();
      await db.clubs.bulkPut(SEED_CLUBS.map(id=>({id})));

      // Library (from spreadsheet + tweaks)
      await db.library_items.clear();
      const now = Date.now();
      for(const item of SEED_LIBRARY){
        await db.library_items.add({
          ...item,
          active: true,
          createdAt: now,
          updatedAt: now
        });
      }

      // Create Default plan with all non-Note items in section order
      const defaultPlanId = await db.plans.add({ name:'Default', isDefault:true, createdAt:now, updatedAt:now });
      const all = await db.library_items.toArray();
      const byName = new Map(all.map(i=>[i.name, i.id]));
      const order = [];
      for(const sec of SECTIONS){
        for(const item of SEED_LIBRARY){
          if(item.section===sec && item.contentType!=="Note"){
            order.push(item.name);
          }
        }
      }
      let idx = 1;
      for(const n of order){
        const id = byName.get(n);
        if(id){ await db.plan_items.add({ planId: defaultPlanId, libraryItemId: id, order: idx++ }); }
      }

      await db.settings.put({ key:'seed_template_v1_1', value:true });
    });
  }

  // ------------------------------
  // Mini router (no page reload)
  // ------------------------------
  const views = {
    home: document.getElementById('view-home'),
    library: document.getElementById('view-library')
  };
  function show(id){
    Object.values(views).forEach(v=>v.classList.add('hidden'));
    views[id].classList.remove('hidden');
    localStorage.setItem('lastView', id);
  }

  // Nav buttons
  document.querySelectorAll('[data-nav]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-nav');
      if(!views[id]) return;
      show(id);
      if(id==='library') renderLibraryList();
    });
  });

  // ------------------------------
  // Library: list + filters
  // ------------------------------
  const libList = document.getElementById('lib-list');
  const fSearch = document.getElementById('lib-search');
  const fFilterSection = document.getElementById('lib-filter-section');
  const fFilterType = document.getElementById('lib-filter-type');

  [fSearch, fFilterSection, fFilterType].forEach(el=>{
    el.addEventListener('input', renderLibraryList);
  });

  function secOrder(s){ return SECTIONS.indexOf(s); }

  async function renderLibraryList(){
    const q = (fSearch.value||'').toLowerCase();
    const sec = fFilterSection.value;
    const typ = fFilterType.value;

    let items = await db.library_items.toArray();
    items = items.filter(it=>it.active!==false);

    if(q) items = items.filter(it=> it.name.toLowerCase().includes(q));
    if(sec) items = items.filter(it=> it.section===sec);
    if(typ) items = items.filter(it=> it.contentType===typ);

    items.sort((a,b)=> (secOrder(a.section) - secOrder(b.section)) || a.name.localeCompare(b.name));

    libList.innerHTML = '';
    if(!items.length){
      libList.innerHTML = `<div class="muted">No items found. Try clearing filters.</div>`;
      return;
    }

    for(const it of items){
      const div = document.createElement('div');
      div.className = 'item';
      const tags = (it.tags||[]).map(t=>`<span class="tag">${t}</span>`).join(' ');
      div.innerHTML = `
        <div class="meta">
          <strong>${it.name}</strong>
          <span class="pill">${it.section}</span>
          <span class="pill">${it.contentType}</span>
          ${tags}
        </div>
        <div class="row">
          <button class="btn ghost" data-edit="${it.id}">Edit</button>
          <button class="btn ghost" data-toggle="${it.id}">${it.active===false? 'Activate':'Hide'}</button>
          <span class="kbd">id:${it.id}</span>
        </div>`;
      libList.appendChild(div);
    }

    libList.querySelectorAll('[data-edit]').forEach(b=> b.addEventListener('click', ()=> loadEditor(parseInt(b.dataset.edit))));
    libList.querySelectorAll('[data-toggle]').forEach(b=> b.addEventListener('click', ()=> toggleActive(parseInt(b.dataset.toggle))));
  }

  async function toggleActive(id){
    const it = await db.library_items.get(id);
    if(!it) return;
    await db.library_items.update(id, { active: !(it.active!==false), updatedAt:Date.now() });
    renderLibraryList();
  }

  // ------------------------------
  // Library: editor
  // ------------------------------
  const editor = {
    title: document.getElementById('editor-title'),
    name: document.getElementById('f-name'),
    section: document.getElementById('f-section'),
    type: document.getElementById('f-type'),
    tags: document.getElementById('f-tags'),
    active: document.getElementById('f-active'),
    primary: document.getElementById('f-primary'),
    fields: document.getElementById('f-fields'),
    defaultsRows: document.getElementById('defaults-rows'),
    cancel: document.getElementById('btn-cancel'),
    save: document.getElementById('btn-save'),
    addDefault: document.getElementById('btn-add-default'),
  };

  let editingId = null;

  function refreshPrimaryOptions(preserveSelection=true){
    let selected = preserveSelection ? editor.primary.value : '';
    let fields;
    try { fields = JSON.parse(editor.fields.value || '[]'); } catch(e){ fields = []; }
    editor.primary.innerHTML = '<option value="">‚Äî None ‚Äî</option>';
    if(Array.isArray(fields)){
      fields.forEach(f=>{
        if(!f || !f.key) return;
        const opt = document.createElement('option');
        opt.value = f.key;
        const text = (f.label || f.key) + ' (' + f.key + ')';
        opt.textContent = text;
        editor.primary.appendChild(opt);
      });
      const marked = fields.find(f=>f.isPrimaryMetric);
      const pick = (marked && marked.key) || selected;
      if(pick && editor.primary.querySelector('option[value="'+pick+'"]')){
        editor.primary.value = pick;
      } else {
        editor.primary.value = '';
      }
    }
  }

  // Update options whenever fields JSON changes
  editor.fields.addEventListener('input', ()=> refreshPrimaryOptions(true));

  function clearEditor(){
    editingId = null;
    editor.title.textContent = 'Add / Edit Item';
    editor.name.value = '';
    editor.section.value = '';
    editor.type.value = '';
    editor.tags.value = '';
    editor.active.value = 'true';
    editor.primary.value = '';
    editor.fields.value = '';
    editor.defaultsRows.innerHTML = '';
    refreshPrimaryOptions(false);
  }

  function addDefaultRow(k='', v=''){
    const wrap = document.createElement('div');
    wrap.className = 'row';
    wrap.style.marginTop = '6px';
    wrap.innerHTML = `
      <input class="def-k" placeholder="key (e.g., attempts)" value="${k}"/>
      <input class="def-v" placeholder="value (e.g., 20)" value="${v}"/>
      <button class="btn ghost">‚úñ</button>
    `;
    wrap.querySelector('button').addEventListener('click', ()=> wrap.remove());
    editor.defaultsRows.appendChild(wrap);
  }

  function defaultsFromUI(){
    const rows = editor.defaultsRows.querySelectorAll('.row');
    const obj = {};
    rows.forEach(r=>{
      const k = r.querySelector('.def-k').value.trim();
      const vRaw = r.querySelector('.def-v').value.trim();
      if(!k) return;
      let v = vRaw;
      if(vRaw.toLowerCase() === 'null') v = null;
      else if(vRaw === '') v = '';
      else if(!isNaN(Number(vRaw))) v = Number(vRaw);
      obj[k] = v;
    });
    return obj;
  }

  function defaultsToUI(obj={}){
    editor.defaultsRows.innerHTML='';
    Object.entries(obj).forEach(([k,v])=> addDefaultRow(k, String(v)));
  }

  async function loadEditor(id){
    const it = await db.library_items.get(id);
    if(!it) return;
    editingId = id;
    editor.title.textContent = `Editing: ${it.name}`;
    editor.name.value = it.name;
    editor.section.value = it.section;
    editor.type.value = it.contentType;
    editor.tags.value = (it.tags||[]).join(', ');
    editor.active.value = (it.active!==false).toString();
    editor.fields.value = JSON.stringify(it.fields||[], null, 2);
    refreshPrimaryOptions(false);
    editor.primary.value = (it.fields?.find(f=>f.isPrimaryMetric)?.key)||'';
    defaultsToUI(it.defaults||{});
    window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
  }

  // Template helpers
  document.getElementById('btn-template-putting').addEventListener('click', ()=>{
    editor.fields.value = JSON.stringify([
      { key:'score', label:'Score', type:'int', unit:'pts', isPrimaryMetric:true, aggregation:'sum' },
      { key:'attempts', label:'Attempts', type:'int', unit:'attempts', aggregation:'sum', required:true },
      { key:'distance', label:'Distance', type:'float', unit:'ft', aggregation:'avg', role:'context' }
    ], null, 2);
    refreshPrimaryOptions(false);
  });
  document.getElementById('btn-template-range').addEventListener('click', async ()=>{
    const clubs = await db.clubs.toArray();
    editor.fields.value = JSON.stringify([
      { key:'score', label:'Score', type:'int', unit:'pts', isPrimaryMetric:true, aggregation:'sum' },
      { key:'attempts', label:'Attempts', type:'int', unit:'attempts', aggregation:'sum', required:true },
      { key:'club', label:'Club', type:'enum', enumValues: clubs.map(c=>c.id), role:'context', required:true },
      { key:'distance', label:'Distance', type:'float', unit:'yds', aggregation:'avg', role:'context' }
    ], null, 2);
    refreshPrimaryOptions(false);
  });
  document.getElementById('btn-template-course').addEventListener('click', ()=>{
    editor.fields.value = JSON.stringify([
      { key:'to_par', label:'To Par', type:'int', unit:'toPar', isPrimaryMetric:true, aggregation:'sum' },
      { key:'holes', label:'Holes', type:'int', unit:'holes', required:true, aggregation:'sum' }
    ], null, 2);
    refreshPrimaryOptions(false);
  });

  // Save item (Create/Update)
  editor.save.addEventListener('click', async ()=>{
    const name = editor.name.value.trim();
    const section = editor.section.value;
    const contentType = editor.type.value;
    const tags = editor.tags.value.split(',').map(s=>s.trim()).filter(Boolean);
    const active = editor.active.value === 'true';
    const primaryKey = editor.primary.value.trim();

    if(!name) return alert('Name is required.');
    if(!section) return alert('Section is required.');
    if(!contentType) return alert('Type is required.');

    let fields;
    try{ fields = JSON.parse(editor.fields.value || '[]'); }
    catch(e){ return alert('Field Specs JSON is invalid.'); }

    if(!Array.isArray(fields) || fields.length===0){
      return alert('At least one FieldSpec is required.');
    }

    if(primaryKey){
      const hit = fields.find(f=>f.key===primaryKey);
      if(!hit) return alert('Primary Metric Key must match one of the field keys.');
      fields = fields.map(f=> ({...f, isPrimaryMetric: f.key===primaryKey}));
    } else {
      // Clear any previous isPrimaryMetric marks if None selected
      fields = fields.map(f=> ({...f, isPrimaryMetric: false}));
    }

    const defaults = defaultsFromUI();

    // Uniqueness (case-insensitive)
    const dupe = await db.library_items.filter(x => x.name.toLowerCase() === name.toLowerCase() && x.id !== editingId).first();
    if(dupe){
      return alert('An item with this name already exists. Choose a different name.');
    }

    const payload = { name, section, contentType, tags, active, fields, defaults, updatedAt: Date.now() };

    if(editingId){
      await db.library_items.update(editingId, payload);
    }else{
      payload.createdAt = Date.now();
      await db.library_items.add(payload);
    }

    clearEditor();
    renderLibraryList();
    alert('Saved.');
  });

  // Add default row
  editor.addDefault.addEventListener('click', ()=> addDefaultRow());
  document.getElementById('btn-add-item').addEventListener('click', ()=>{ clearEditor(); addDefaultRow(); window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); });
  editor.cancel.addEventListener('click', clearEditor);

  // Init + clear
  async function init(){
    await seedIfNeeded();
    const last = localStorage.getItem('lastView') || 'home';
    show(last);
    if(last==='library') renderLibraryList();
  }

  document.getElementById('btn-clear-db').addEventListener('click', async ()=>{
    if(!confirm('This will remove ALL local data. Proceed?')) return;
    await db.delete();
    location.reload();
  });

  init();
  </script>
</body>
</html>
