<script>
  const $ = (q)=>document.querySelector(q);
  const el = (tag, attrs={}, html='')=>{ const x=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>x.setAttribute(k,v)); if(html) x.innerHTML=html; return x; };

  const store = {
    keySessions: 'fg_sessions_v2',
    keyPlans: 'fg_plans_v2',
    keyActivePlan: 'fg_active_plan_v2',
    keyDrills: 'fg_drills_v2',
    load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch{ return fallback; } },
    save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  };

  // Drill Library
  const defaultDrills = [/* ... unchanged ... */];

  let drills = store.load(store.keyDrills, defaultDrills);
  let plans = store.load(store.keyPlans, []);
  let activePlanId = localStorage.getItem(store.keyActivePlan) || 'default';
  let sessions = store.load(store.keySessions, []);

  // ---- Validation helpers ----
  const validName = (name)=> {
    const t = (name ?? '').trim();
    if(t.length === 0) return false;
    if(t.toLowerCase() === 'null') return false;
    return true;
  };
  const duplicateName = (name, excludeId=null)=> {
    const t = (name ?? '').trim().toLowerCase();
    return plans.some(p => p.id !== excludeId && p.name?.trim().toLowerCase() === t);
  };
  const enforceDefaultName = ()=> {
    const p = plans.find(x=>x.id==='default');
    if (p && !validName(p.name)) { p.name = 'Default'; }
  };

  // Ensure non-deletable Default plan exists
  function ensureDefaultPlan() {
    const hasDefault = plans.some(p => p.id === 'default');
    if (!hasDefault) {
      const allDrillIds = drills.map(d => d.id);
      plans.unshift({ id: 'default', name: 'Default', focus: '', drills: allDrillIds });
      store.save(store.keyPlans, plans);
    }
    enforceDefaultName();
    if (!plans.some(p => p.id === activePlanId)) {
      activePlanId = 'default';
      localStorage.setItem(store.keyActivePlan, activePlanId);
    }
  }
  ensureDefaultPlan();

  // ---------- PLAN TAB ----------
  function renderPlan(){
    const practicePicker = $('#practicePicker'); practicePicker.innerHTML = '';
    plans.forEach(p=> practicePicker.appendChild(el('option',{value:p.id}, p.name)));
    practicePicker.value = activePlanId;

    practicePicker.onchange = ()=>{
      activePlanId = practicePicker.value;
      localStorage.setItem(store.keyActivePlan, activePlanId);
      renderPlan();
      renderLog();
    };

    const plan = getPlan(activePlanId);
    $('#planName').value = plan?.name ?? '';
    $('#planFocus').value = plan?.focus ?? '';

    // Save button with validation
    $('#savePlanBtn').onclick = ()=>{
      const p = getPlan(activePlanId);
      const nameInput = $('#planName').value.trim();
      if(!validName(nameInput)) {
        alert('Plan name cannot be empty or "NULL".');
        $('#planName').value = p.name || (activePlanId==='default' ? 'Default' : '');
        return;
      }
      if(duplicateName(nameInput, activePlanId)) {
        alert('Another plan already has this name. Please choose a different one.');
        $('#planName').value = p.name;
        return;
      }
      p.name = (activePlanId==='default' ? 'Default' : nameInput);
      p.focus = $('#planFocus').value || '';
      store.save(store.keyPlans, plans);
      enforceDefaultName();
      alert('Plan saved.');
      renderPlan();
    };

    // Live validation on rename
    $('#planName').onchange = ()=>{
      const p=getPlan(activePlanId);
      const v = $('#planName').value.trim();
      if(!validName(v)) {
        alert('Plan name cannot be empty or "NULL".');
        $('#planName').value = p.name || (activePlanId==='default' ? 'Default' : '');
        return;
      }
      if(duplicateName(v, activePlanId)) {
        alert('Another plan already has this name.');
        $('#planName').value = p.name;
        return;
      }
      p.name = (activePlanId==='default' ? 'Default' : v);
      store.save(store.keyPlans, plans);
      enforceDefaultName();
      renderPlan();
    };
  }

  // (rest of your code unchanged: renderLog, renderStats, etc.)
</script>
